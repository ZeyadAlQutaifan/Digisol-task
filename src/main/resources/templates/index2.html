<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عروض سفر حصرية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --main-color: #2c3e50;
            --accent-color: #e67e22;
        }

        body {
            background: #f8f9fa;
            font-family: 'Tajawal', sans-serif;
        }

        .hero-section {
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
            url('https://source.unsplash.com/random/1920x600/?travel');
            background-size: cover;
            color: white;
            padding: 120px 0;
            margin-bottom: 40px;
        }

        .offer-card {
            transition: transform 0.3s;
            border: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .offer-card:hover {
            transform: translateY(-10px);
        }

        .price-badge {
            position: absolute;
            top: -15px;
            right: -15px;
            background: var(--accent-color) !important;
            font-size: 1.2rem;
            padding: 10px 20px;
            z-index: 1;
        }

        .pagination .disabled {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>

<section class="hero-section text-center">
    <div class="container">
        <h1 class="display-4 fw-bold mb-4">اكتشف عروض السفر المذهلة</h1>

        <form id="searchForm" class="row g-3 justify-content-center">
            <div class="col-md-3">
                <input type="text" class="form-control form-control-lg" id="fromCity" placeholder="مدينة المغادرة" required>
            </div>

            <div class="col-md-3">
                <input type="text" class="form-control form-control-lg" id="toCity" placeholder="مدينة الوصول" required>
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-warning btn-lg w-100">
                    <i class="bi bi-search"></i> بحث
                </button>
            </div>
        </form>
    </div>
</section>


<!-- Results Section -->
<main class="container">
    <div id="results" class="row g-4"></div>

    <!-- Pagination -->
    <nav class="d-flex justify-content-center my-5" id="pagination">
        <ul class="pagination">
            <li class="page-item">
                <button class="page-link" type="button" onclick="prevPage()">&laquo; السابق</button>
            </li>
            <li class="page-item">
                <span class="page-link bg-warning text-dark" id="pageNumber">1</span>
            </li>
            <li class="page-item">
                <button class="page-link" type="button" onclick="nextPage()">التالي &raquo;</button>
            </li>
        </ul>
    </nav>
</main>

<script>
    let currentPage = 0; // تبدأ من 0 حسب Spring Data
    let totalPages = 0;
    const pageSize = 10; // يجب أن تطابق القيمة الافتراضية في الباكند

    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        currentPage = 0; // إعادة التعيين مع بحث جديد
        fetchOffers();
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentPage > 0) {
            currentPage--;
            fetchOffers();
        }
    });

    document.getElementById('nextBtn').addEventListener('click', () => {
        if (currentPage < totalPages - 1) {
            currentPage++;
            fetchOffers();
        }
    });

    async function fetchOffers() {
        const from = document.getElementById('fromCity').value;
        const to = document.getElementById('toCity').value;

        // إظهار حالة التحميل
        toggleLoading(true);

        try {
            const response = await fetch(`/search?fromCity=${encodeURIComponent(from)}&toCity=${encodeURIComponent(to)}&page=${currentPage}&size=${pageSize}`);
            const data = await response.json();

            renderOffers(data.content);
            updatePagination(data);
        } catch (error) {
            console.error('Error:', error);
            showError();
        } finally {
            toggleLoading(false);
        }
    }

    function renderOffers(offers) {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';

        if (offers.length === 0) {
            resultsDiv.innerHTML = `
                <div class="col-12 text-center py-5">
                    <h3 class="text-muted">لا توجد نتائج</h3>
                </div>`;
            return;
        }

        offers.forEach(offer => {
            const card = document.createElement('div');
            card.className = 'col-md-6 col-lg-4';
            card.innerHTML = `
                <div class="offer-card card h-100 position-relative">
                    <span class="price-badge badge rounded-pill">$${offer.price}</span>
                    <img src="${offer.imageUrl}"
                         class="card-img-top"
                         alt="${offer.toCity}"
                         loading="lazy">
                    <div class="card-body">
                        <h5 class="card-title">${offer.fromCity} ➔ ${offer.toCity}</h5>
                        <div class="card-text">
                            <p class="text-muted">
                                <i class="bi bi-building"></i> ${offer.hotelName}
                            </p>
                            <div class="d-grid">
                                <button class="btn btn-outline-warning">احجز الآن</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            resultsDiv.appendChild(card);
        });
    }

    function updatePagination(data) {
        totalPages = data.totalPages;
        document.getElementById('pageInfo').innerText = `الصفحة ${currentPage + 1} من ${totalPages}`;

        // تعطيل الأزرار عند الحاجة
        document.getElementById('prevBtn').disabled = currentPage === 0;
        document.getElementById('nextBtn').disabled = currentPage === totalPages - 1;
    }

    function toggleLoading(isLoading) {
        const buttons = document.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.disabled = isLoading;
        });

        if (isLoading) {
            document.getElementById('pagination').classList.add('opacity-50');
        } else {
            document.getElementById('pagination').classList.remove('opacity-50');
        }
    }

    function showError() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `
            <div class="col-12 text-center py-5">
                <h3 class="text-danger">حدث خطأ أثناء جلب البيانات</h3>
                <button class="btn btn-outline-danger mt-3" onclick="fetchOffers()">إعادة المحاولة</button>
            </div>`;
    }
</script>

</body>
</html>